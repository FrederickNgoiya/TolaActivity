{% load i18n %}

<script>
    var validation_msgs = {};
    let initialTrackedFieldsFormState;

    const DELETE_ALL_TARGETS_MESSAGE = "{% trans 'Any results assigned to these targets will need to be reassigned. For future reference, please provide a reason for deleting these targets.' %}"
    const DELETE_INDICATOR_MESSAGE = "{% trans 'All details about this indicator and results recorded to the indicator will be permanently removed. For future reference, please provide a reason for deleting this indicator.' %}"
    const MODIFY_TARGETS_MESSAGE = "{% trans 'Modifying target values will affect program metrics for this indicator. For future reference, please provide a reason for modifying target values.' %}"
    const DESTRUCTIVE_PREAMBLE = "{% trans 'This action cannot be undone.' %}"
    const DELETE_INDICATOR_PREAMBLE = "{% trans 'All details about this indicator will be permanently removed.' %}"
    const DELETE_INDICATOR_NO_RATIONALE = "{% trans 'Are you sure you want to delete this indicator?' %}"
    const DELETE_TARGETS_NO_RATIONALE = "{% trans 'Are you sure you want to remove all targets?' %}"
    const DELETE_TARGET_NO_RATIONALE = "{% trans 'Are you sure you want to remove this target?' %}"
    const DELETE_TARGET_MESSAGE = "{% trans 'For future reference, please provide a reason for deleting this target.' %}"
    
    // Indicator fields tracked in the admin changelog, which require prompting for a rationale if modified
    let TRACKED_FIELDS = new Set([
        'name',
        'unit_of_measure',
        'unit_of_measure_type',
        'is_cumulative',
        'lop_target',
        'direction_of_change',
        'baseline',
        'baseline_na',
        'periodic_targets',
        'target_frequency',
    ]);

    // Open the modal with a create form (as opposed to an update form)
    function openCreateIndicatorFormModal(programId) {
        let url = `/indicators/indicator_create/${programId}/`;

        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();

        $("#indicator_modal_content").load(url);
        $("#indicator_modal_div").modal('show');
    }

    $( document ).ready(function() {
        show_hide_frequency_fields();
        if ($("#id_objectives option").length < 1) {
            $("#id_objectives").attr("disabled", true)
        }

    });

    $("#indicator_modal_div").on('shown.bs.modal', function() {

    });

    $("#indicator_modal_div").on('shown.bs.tab', function() {
        show_hide_frequency_fields();
    });


    function confirmAndRedirect(delete_indicator) {
        var has_results = parseInt($('#numDataPoints').text()) > 0;
        if(!has_results) {
            create_no_rationale_changeset_notice({
                preamble: [DESTRUCTIVE_PREAMBLE, DELETE_INDICATOR_PREAMBLE].join(' '),
                message_text: DELETE_INDICATOR_NO_RATIONALE,
                context: document.getElementById('indicator_update_form'),
                on_submit: delete_indicator
            });
        } else {
            create_destructive_changeset_notice({
                message_text: DELETE_INDICATOR_MESSAGE,
                context: document.getElementById('indicator_update_form'),
                on_submit: delete_indicator,
                showCloser: true
            });
        }
        scrollToIndicatorFormBottom();
    }
    
    $('#indicator_modal_content').on("click", "#id_delete_indicator_btn", function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        var delete_indicator;
        if ($('#indicator_modal_content').attr('iptt-modal') === 'true') {
            delete_indicator = (rationale) => {
                $.post(url, {rationale: rationale, redirect: true})
                .done(function(data, textStatus, jqXHR){
                 if (data.status == "success") {
                    window.location.reload();
                 } else {
                     createAlert("danger", data.msg, true, "#modalmessages");
                     $('#indicator_modal_div').animate({ scrollTop: 0 }, 'slow');
                 }
             });
            }
        } else {
            delete_indicator = (rationale) => {
                var url = $(this).attr('href');
                $.post(url, {rationale: rationale})
                 .done(function(data, textStatus, jqXHR){
                     if (data.status == "success") {
                        var success = PNotify.success({
                            title: "{% trans 'Success' %}",
                            text: data.msg,
                            type: 'success',
                            width: '350px',
                            minHeight: '150px',
                            stack: {
                                'dir1': 'right',
                                'dir2': 'up',
                                'firstpos1': 0,
                                'firstpos2': 0
                                },
                            modules: {
                                Buttons: {
                                    closer: true,
                                    closerHover: false,
                                    sticker: false
                                }
                            }
                            });
                        $('#indicator_modal_div').find('form').attr('deleted', true);
                        $('#indicator_modal_div').modal('hide');
                     } else {
                         createAlert("danger", data.msg, true, "#modalmessages");
                         $('#indicator_modal_div').animate({ scrollTop: 0 }, 'slow');
                     }
                 });
            }
        }
        confirmAndRedirect(delete_indicator);
    });
    
    $('#indicator_modal_content').on('click', '.event-target-delete-button', function(e) {
        e.preventDefault();
        const updateIfLastEvent = () => {
            if ($('.periodic-target').length == 0) {
                $('.periodic-targets').remove();
                reset_frequency_fields();
                show_hide_frequency_fields();
            }
        };
        var url = $(this).attr('href');
        let row = $(e.currentTarget).closest('tr');
        let numDataTarget = parseInt(row.data('collected-count'));
        // if no other targets have changed, we'll update the snapshot so we don't double-prompt for rationale
        const updateSnapshot = !(
            JSON.stringify(getFormPeriodicTargets(row)) == initialTrackedFieldsFormState.periodic_targets &&
            initialTrackedFieldsFormState.target_frequency == getTrackedFieldsObject().target_frequency
            );
         /* If target is new, delete means just remove row,
         * If target is saved, delete means call to delete
         */
        const delete_callback = url == '#' ?
            (url, row) => () => {
                row.remove();
                updateIfLastEvent();
            } :
            (url, row) => (rationale) => {
                $.post(url, {rationale: rationale})
                    .done((data) => {
                        if (data.status == "success") {
                            row.remove();
                            if (updateSnapshot) updateTargetSnapshot();
                            updateIfLastEvent();
                        }
                    });
            };
        let numDataIndicator = parseInt($('#numDataPoints').text());
        /* If target has results, message refers to number of results,
         * Otherwise, if indicator has results and target is not brand new, record rationale
         * otherwise merely confirm:
         */
        const preamble = numDataTarget == 0 ? DESTRUCTIVE_PREAMBLE :
            window.target_with_results_text(numDataTarget);
        const message_text = (url == '#' || numDataIndicator == 0) ?
                DELETE_TARGET_NO_RATIONALE :
                DELETE_TARGET_MESSAGE;
        /* If the indicator has any results linked to it, we prompt for a rationale,
         * otherwise we do not.
         */
        const changeset_notice_function = (url == '#' || numDataIndicator === 0) ?
                window.create_no_rationale_changeset_notice :
                window.create_destructive_changeset_notice;
        changeset_notice_function({
            preamble: preamble,
            message_text: message_text,
            context: document.getElementById('indicator_update_form'),
            on_submit: (rationale = null) => {
                delete_callback(url, row)(rationale);
            }
        });
        scrollToIndicatorFormBottom();
    });


    // Intercept IndicatorUpdate form submission and then use ajax to submit it.
    $("#indicator_modal_content").on("submit", "#indicator_update_form", function(e){
        e.preventDefault();
        if (validateForm() === false) {
            showValidations("#modalmessages");
            return;
        }

        var has_results = parseInt($('#numDataPoints').text()) > 0;
        if(has_results && hasTrackedFieldsChanged()) {
            if(hasTargetsChanged()) {
                window.create_destructive_changeset_notice({
                    message_text: MODIFY_TARGETS_MESSAGE,
                    no_preamble: true,
                    context: document.getElementById('indicator_update_form'),
                    on_submit: (rationale) => {
                        submitForm(rationale);
                    }
                });
            } else {
                window.create_nondestructive_changeset_notice({
                    context: document.getElementById('indicator_update_form'),
                    on_submit: (rationale) => {
                        submitForm(rationale);
                    }
                });
            }
            scrollToIndicatorFormBottom();
        } else {
            submitForm('');
        }
    });


    $("#indicator_modal_content").on("keyup keypress", "#indicator_update_form", function(e){
        var keyCode = e.keyCode || e.which;
        if (keyCode === 13 ){
            e.preventDefault();
            return false;
        }

    });

    $("#indicator_modal_content").on("click", "#id_create_targets_btn", function(e) {
        e.preventDefault();
        if (validateForm() === false) {
            showValidations("#modalmessages");
            return;
        }
        $(this).attr("disabled", true);

        submitForm("{% trans 'N/A' %}");
    });

    function createPeriodicTargetRow(pt, isLastIteration, rowNum) {
        var markup = `
                <tr class="periodic-target" data-collected-count="0" data-ptid="0">
                    <td class="text-left d-flex align-items-center td--stretch">
                        <a href="#" class="deletebtn btn btn-sm event-target-delete-button">
                            <i class="fas fa-times text-danger"></i>
                        </a>
                        <input type="text" placeholder="{% trans 'Enter event name' %}" class="form-control input-text">
                                <span style="margin:0px;" class="help-block"> </span>
                    </td>

                    <td class="text-right">
                        <span class=${ $("#id_unit_of_measure_type_1").is(":checked")?"input-symbol-percent":""}>
                            <input
                                type="number"
                                id="pt-${pt.id}"
                                data-periodictarget="pt"
                                placeholder="{% trans 'Enter target' %}"
                                class="form-control input-value">
                        </span>
                        <span id="hint_id_pt_${pt.period}" style="margin:0px;" class="help-block"> </span>
                    </td>
                </tr>
            `;
        return markup;
    }

    // delete periodic_target
    $("#indicator_modal_content").on("click", "#id_delete_targets_btn", function(e) {
        e.preventDefault();
        var form_url = $("#indicator_update_form").attr('action');
        var indicator_id = form_url.split('/').slice(-2, -1)[0];
        var dataCountAttribute = $("#periodic_targets_table tr").attr("data-collected-count");
        var msg = '';

        const save = (rationale) => {
            $.post('/indicators/periodic_target_deleteall/' + indicator_id + '/true/', {rationale}, function(data){
                var res = $.parseJSON(data);
                if (res['status'] == 'success') {
                    $("#id_div_periodic_tables_placeholder").empty();
                    reset_frequency_fields();
                    show_hide_frequency_fields();
                }

            });
        }

        var has_results = parseInt($('#numDataPoints').text()) > 0;
        if(has_results) {
            window.create_destructive_changeset_notice({
                message_text: DELETE_ALL_TARGETS_MESSAGE,
                context: document.getElementById('indicator_update_form'),
                on_submit: save
            });
            scrollToIndicatorFormBottom();
        } else {
            window.create_no_rationale_changeset_notice({
                preamble: DESTRUCTIVE_PREAMBLE,
                message_text: DELETE_TARGETS_NO_RATIONALE,
                context: document.getElementById('indicator_update_form'),
                on_submit: save
            });
        }
        scrollToIndicatorFormBottom();
    });

    // add new periodic target
    $("#indicator_modal_content").on("click", "#addNewPeriodicTarget", function(e) {
        e.preventDefault();
        var numTargets = $("#periodic_targets_table tbody tr").length-1;
        var form_url = $("#indicator_update_form").attr('action');
        var indicator_id = form_url.split('/').slice(-2, -1)[0]
        $.get('/indicators/periodic_target_generate/' + indicator_id + '/?numTargets=' + numTargets, function(data){
            var pt = $.parseJSON(data);
            var isLastIteration = true;
            var markup = createPeriodicTargetRow(pt, isLastIteration);
            $("#periodic_targets_table tbody tr:nth-last-child(2)").before(markup);
        });
    });

    $('#indicator_modal_content').on('click', "input[type='reset']", function(e) {
    })

 function submitForm(rationale = '') {
        var numDataPoints = parseInt($("#numDataPoints").text());
        var initalTargetFrequency = parseInt($("#initialTargetFrequencyValue").text());
        var target_frequency = $("#id_target_frequency").val();

        // warning when changing for LoP target value to something non-LoP
        if (numDataPoints > 0 && initalTargetFrequency == 1 && target_frequency != 1) {
            const message_text = window.lop_to_non_lop_with_results_text(numDataPoints);
            window.create_no_rationale_changeset_notice({
                preamble: DESTRUCTIVE_PREAMBLE,
                message_text: message_text,
                context: document.getElementById('indicator_update_form'),
                on_submit: () => {
                    formSubmitContinue(rationale);
                },
                on_cancel: () => {
                    $('#id_target_frequency').val('1');
                    $('#id_create_targets_btn').attr("disabled", false);
                    show_hide_frequency_fields();
                }
            });
        } else {
            formSubmitContinue(rationale);
        }
 }
 
function formSubmitContinue(rationale = '') {
        let $form = $('#indicator_update_form');
        var submitBtnName = $form.find("input[type=submit]:focus" );
        var form_url = $form.attr('action');

        // if there are errors in periodic targets then do not submit the form
        if ($("#id_div_periodic_tables_placeholder input").parent().hasClass('has-error')) { return; }

        let formArr = $form.serializeArray();
        let form_periodic_targets = getFormPeriodicTargets();
        let periodic_targets_to_submit = $.isEmptyObject(form_periodic_targets) ?
            'generateTargets' : JSON.stringify(form_periodic_targets);
        formArr.push({"name": "periodic_targets", "value": periodic_targets_to_submit});

        if (formArr.find(e => e.name === 'is_cumulative') === undefined) {
            formArr.push({name: 'is_cumulative', value: 3});
        }

        // user entered rationale for change
        formArr.push({name: 'rationale', value: rationale});

        //disable submit button as we are posting and want to prevent double-saves while waiting:
        submitBtnName.attr('disabled', true);

        $.ajax({
            method: 'POST',
            url: form_url,
            data: formArr,
        }).done(function(data, textStatus, jqXHR) {
            //undisable submit button as the response is returned:
            submitBtnName.attr('disabled', false);
            var alertsElement = "#alerts";
            if ( $("#modalmessages").length) {
                alertsElement = "#modalmessages";
            }
            // if there are any erros show them and then STOP
            if (jqXHR.getResponseHeader('error') == "True") {
                //$("#modalerrors").html(data);
                createAlert("danger", data, true, alertsElement);
                return;
            }

            $(alertsElement).html('');

            createAlert("success", "{% trans 'Success, form data saved.'|escapejs %}", true, alertsElement);

            var jsondata = $.parseJSON(data);
            var indicator = $.parseJSON(jsondata["indicatorjson"])[0];
            var targets_sum = jsondata["targets_sum"];
            var content = jsondata["content"];

            $("#initialTargetFrequencyValue").text(indicator.fields.target_frequency);
            if ($("#id_target_frequency").val() != 1) {
                $("#id_div_periodic_tables_placeholder").empty();
                $("#id_div_periodic_tables_placeholder").append(content);
                if (indicator.fields.unit_of_measure_type == 1) {
                    $("#id_span_targets_sum").text(parseFloat(targets_sum).toFixed(2).replace(/[.,]00$/, ""));
                }

            }

            scrollToTop();

            show_hide_frequency_fields(true);
            toggleTargetsSumOrAvgRow()
            if ($("#id_unit_of_measure_type_1").is(":checked")) {
                show_hide_cummulative_inputs('percent')
            }
            else {
                show_hide_cummulative_inputs('number')
            }

            // this is our new base state
            recordTrackedFieldsSnapshot();
        }).fail((xhr, text, error) => {
            var alertsElement = "#alerts";
            if ( $("#modalmessages").length) {
                alertsElement = "#modalmessages";
            }

            $(alertsElement).html('');

            submitBtnName.attr('disabled', false);
        });
    }

    // auto scroll either a modal or the whole page to the top
    function scrollToTop() {
        if ($('#indicator_modal_div').length == 1) {
            // for the modal version;
            $("#indicator_modal_div").animate({ scrollTop: 0 }, 'slow');
        } else {
            // for the non-modal version;
            $("html, body").animate({ scrollTop: 0 }, "slow");
        }
    }


    function reset_frequency_fields() {
        $("#id_target_frequency").val('');
        $("#id_target_frequency option:not(:selected)").attr("disabled", false);
        $("#id_target_frequency").attr("readonly", false);
        $("#id_create_targets_btn").attr("disabled", false);
        $("#id_target_frequency_num_periods").val(1);
        $("#id_target_frequency_custom").val('');
    }


    function show_hide_frequency_fields(lock = false) {
        // set the text for the 'create new target' button.
        var selected_option = parseInt($("#id_target_frequency").find("option:selected").val()) || 0;
        if ( (lock == true || $('#id_target_frequency').attr('readonly'))
                 && selected_option != 1) {
            $("#id_target_frequency option:not(:selected)").attr("disabled", true);
            $("#id_target_frequency").attr("readonly", true);
            $("#id_create_targets_btn").attr("disabled", true);
            $("#div_id_target_frequency_num_periods").hide();
            $("#div_id_target_frequency_custom").hide();
            lock = true;
        }
        if (selected_option == 1 || selected_option == 0) {
            $("#div_id_create_targets_btn").hide();
        } else {
            if ($("#id_div_periodic_tables_placeholder").children().length > 0) {
                $("#id_delete_targets_btn").show();
            } else {
                $("#id_delete_targets_btn").hide();
            }

            if (selected_option == 8) {
                $("#div_id_target_frequency_num_periods label").text("{% trans 'Number of events' %}")
                .addClass('label--required');
                $("#div_id_target_frequency_custom label").addClass('label--required');
                $("#div_id_create_targets_btn").show();
            } else {
                $("#div_id_target_frequency_num_periods").hide();
                $("#div_id_create_targets_btn").show();
            }
        }



        if (lock == false) {
            if (selected_option == 1 ||
                selected_option == 2 ||
                selected_option == 0) {
                $("#div_id_target_frequency_num_periods").hide();
                $("#div_id_target_frequency_custom").hide();
                $("#id_target_frequency_custom").val('');

            } else if (selected_option == 8) {
                $("#div_id_target_frequency_custom").show();
                $("#div_id_target_frequency_num_periods").show();
            } else {
                $("#div_id_target_frequency_num_periods").hide();
                $("#div_id_target_frequency_custom").hide();
                $("#id_target_frequency_custom").val('');
            }
        }
    }

    $("#indicator_modal_content").on("change blur", "#id_target_frequency", function(e){
      if ($("#id_target_frequency option:selected").text().indexOf("---") < 0) {
        $("#id_target_frequency").removeClass('is-invalid');
        $("#validation_id_target_frequency").text(" ");
        $("#div_id_target_frequency").removeClass('marginbottom-225');
        $("#div_id_target_frequency").addClass('mb-3');
      }
      else {
        $("#div_id_target_frequency").addClass('marginbottom-225');
        $("#div_id_target_frequency").removeClass('mb-3');
      }
      show_hide_frequency_fields();
    });


    function reset_baseline_errors(){
        $("#id_baseline").removeClass('is-invalid');
        $("#id_baseline_na").removeClass('is-invalid');
        $("#validation_id_baseline").html("");
    }

    function validate_baseline() {
        const baseline = $("#id_baseline");
        const baseline_na = $("#id_baseline_na");
        let errMsg = undefined;

        if (baseline_na.is(':checked') == true) {
            reset_baseline_errors();
            return true;
        }

        if (!baseline.val()) {
            errMsg = "{% trans 'Please complete this field. Your baseline can be zero.'|escapejs %}";
        } else if (!$.isNumeric(baseline.val()) || baseline.val() < 0 ) {
            errMsg = "{% trans 'Please complete this field. Your baseline can be zero.'|escapejs %}";
            return false;
        }
        if (errMsg){
            baseline.addClass('is-invalid');
            // baseline_na.addClass('is-invalid');
            $("#validation_id_baseline").html(errMsg);
        } else {
            reset_baseline_errors();
            errMsg = undefined;
            return true;
        }
    }

    function validate_loptarget() {
        const lop = $("#id_lop_target");
        let errMsg = undefined;
        if (!lop.val()) {
            errMsg = "{% trans 'Please enter a number larger than zero.'|escapejs %}";
        } else if (!$.isNumeric(lop.val()) || lop.val() <= 0) {
            errMsg = "{% trans 'Please enter a number larger than zero with no letters or symbols.'|escapejs %}";
        }

        if (errMsg) {
            lop.addClass('is-invalid');
            $("#validation_id_lop_target").text(errMsg);
            return false;
        } else {
            lop.removeClass('is-invalid');
            $("#validation_id_lop_target").text(" ");
            errMsg = undefined;
            lop.val(Math.round(lop.val() * 100) / 100);
            return true;
        }
    }

    function validateForEmptyField(fieldName) {
        /* on the IPTT edit form there are multiple "id_level" fields (one for
         * filter form, one for edit form) so in case of id_level validation
         * this ensures we get the one on the edit form
         */
        var field;
        if (fieldName == "id_level") {
            field = $('#performanceTab #id_level');
        } else {
            field = $("#" + fieldName);
        }
        if ($.isEmptyObject(field.val())) {
            $(field).addClass('is-invalid');
            $("#validation_" + fieldName).text("{% trans 'Please complete this field.'|escapejs %}");
            return false;
        } else {
            $(field).removeClass('is-invalid');
            $("#validation_" + fieldName).text(" ");
            return true;
        }
    }

    function validateNumPeriods() {
        const fieldId = "id_target_frequency_num_periods";
        const numPeriodsField = $("#" + fieldId);
        let errMsg = undefined;
        if (numPeriodsField.is(":visible")) {
            if (numPeriodsField.val() > 12) {
                errMsg = "{% trans 'You can start with up to 12 targets and add more later.'|escapejs %}";
            } else if (!numPeriodsField.val()) {
                errMsg = "{% trans 'Please complete this field.'|escapejs %}";
            } else if (numPeriodsField.val() < 0) {
                errMsg = "{% trans 'Please enter a number larger than zero.'|escapejs %}";
            }

            if (errMsg) {
                numPeriodsField.addClass('is-invalid');
                $("#div_id_target_frequency_num_periods").removeClass('mb-3');
                $("#div_id_target_frequency_num_periods").addClass('mb-5');
                $("#validation_" + fieldId).text(errMsg);
                return false;
            } else {
                numPeriodsField.removeClass('is-invalid');
                $("#validation_" + fieldId).text(" ");
                errMsg = undefined;
                return true;
            }
        }
    }

    function validatePeriodicTargets(){
        let errorFlag = false;
        // validate target values (number fields)
        $("#periodic_targets_table input[type=number]").each(function(){
            if ($(this).attr('id').substr(0, 2) == "pt" ) {
                let val = $(this).val();
                if (val && $.isNumeric(val) && val >= 0) {
                    $(this).removeClass('is-invalid');
                } else {
                    $(this).addClass('is-invalid');
                    errorFlag = true;
                }
            }
        });

        // validate target labels (text fields)
        $("#periodic_targets_table input[type=text]").each(function(){
            if ($(this).val()) {
                $(this).removeClass('is-invalid');
            } else {
                $(this).addClass('is-invalid');
                errorFlag = true;
            }
        });

        if (errorFlag) {
            $("#id_pt_errors").html(`<span class="target-value-error"><small>${getPTMessage()}</small></span>`);
        }
    }


    function getPTMessage () {
        if ($("#periodic_targets_table input[type=text]").length > 0){
            return ("{% trans 'Please enter a name and target number for every event. Your target value can be zero.'|escapejs %}");
        }
        else {
            return ("{% trans 'Please enter a number with no letters or symbols.'|escapejs %}");
        }
    }


    function showValidations(messagesDiv) {
        var msg = '';
        $.each(validation_msgs, function(k,v) {
            msg += v + '<br>';
        });
        $(messagesDiv).empty();
        if (!jQuery.isEmptyObject(validation_msgs)) {
            createAlert('danger', msg, false, messagesDiv);
            scrollToTop();
        }
        validation_msgs = {};
    }

    function validateForm() {
        // Clear any existing messages
        validation_msgs = {};

        var validationsTargetTab = true;
        var validationsSummaryTab = true;
        var validationsPerformanceTab = true;
        if  (validate_baseline() === false ) {
            validationsTargetTab = false
        }
        if (validate_loptarget() === false ) {
            validationsTargetTab = false;
        }
        if (validateForEmptyField("id_unit_of_measure") === false ) {
            validationsTargetTab = false;
        }
        if ($("#id_target_frequency_custom").is(":visible")){
          if (validateForEmptyField("id_target_frequency_custom") === false) {
            $("#div_id_target_frequency_custom").addClass('mb-5');
            $("#div_id_target_frequency_custom").removeClass('mb-3');
            validationsTargetTab = false;
          }
          else {
            $("#div_id_target_frequency_custom").addClass('mb-3');
            $("#div_id_target_frequency_custom").removeClass('mb-5');
          }
        }
        if (validateForEmptyField("id_target_frequency") === false) {
            validationsTargetTab = false;
            $("#div_id_target_frequency").addClass("marginbottom-225");
            $("#div_id_target_frequency").removeClass("mb-3")
        }
        if (validateNumPeriods() === false) {
            validationsTargetTab = false;
        }

        if (validatePeriodicTargets() === false) {
            validationsTargetTab = false;
        }

        // validate periodic targets
        if ($("#id_div_periodic_tables_placeholder input").hasClass('is-invalid')) {
            validationsTargetTab = false;
        }

        if (validationsTargetTab === false) {
            validation_msgs['target'] = '{% trans "Please complete all required fields in the Targets tab."|escapejs %}';
        }

        /* validate fields from the summary tab */
        if (validateForEmptyField("id_name") === false) {
            validationsSummaryTab = false;
            $("#div_id_name").addClass("marginbottom-225");
            $("#div_id_name").removeClass("mb-3");
        }
        else {
          $("#div_id_name").addClass("mb-3");
          $("#div_id_name").removeClass("marginbottom-225");
        }

        if (validationsSummaryTab === false) {
            validation_msgs['summary'] = '{% trans "Please complete all required fields in the Summary tab."|escapejs %}';
        }

        /* validate fields from the Performance tab */
        if (validateForEmptyField("id_level") === false) {
            validationsPerformanceTab = false;
        }

        if (validationsPerformanceTab === false) {
            validation_msgs['performance'] = '{% trans "Please complete all required fields in the Performance tab."|escapejs %}';
        }

        // return all tab validations
        return validationsTargetTab && validationsSummaryTab && validationsPerformanceTab;
    }

    $("#indicator_modal_content").on("keypress", "input[type=number]", function(e){
        if (e.which == 69 || e.which == 101){ //69 = e | 101 = E
            e.preventDefault();
        }
    });

    $("#indicator_modal_content").on("input", "#periodic_targets_table input[type=number]", function(e){
        if ($(this).val() && $(this).val() >= 0) {
            $(this).removeClass('is-invalid');
            $("#id_pt_errors").text('');
        } else {
            $(this).addClass('is-invalid');
        }

        if ($("#id_div_periodic_tables_placeholder input[type=number], input[type=text]").hasClass("is-invalid") ) {
            $("#id_pt_errors").html(`<span class="target-value-error"><small>${getPTMessage()}</small></span>`);
        }
    });

    $("#indicator_modal_content").on("input", "#periodic_targets_table input[type=text]", function(e){
        if ($(this).val()) {
            $(this).removeClass('is-invalid');
            $("#id_pt_errors").text('');
        } else {
            $(this).addClass('is-invalid');
        }
        if ($("#id_div_periodic_tables_placeholder input[type=text], input[type=number]").hasClass("has-error") ) {
            $("#id_pt_errors").html(`<span class="target-value-error"><small>${getPTMessage()}</small></span>`);
        }
    });

    $("#indicator_modal_content").on("blur", "#id_unit_of_measure", function(e){
        validateForEmptyField("id_unit_of_measure");
    });

    $("#indicator_modal_content").on("blur", "#id_level", function(e){
        validateForEmptyField("id_level");
    });

    $("#indicator_modal_content").on("blur", "#id_target_frequency", function(e){
        validateForEmptyField("id_target_frequency");
    });

    $("#indicator_modal_content").on("blur", "#id_lop_target", function(e){
        validate_loptarget();
    });

    $("#indicator_modal_content").on("blur", "#id_baseline", function(e){
        $("#id_baseline_na").prop('checked', false);
        validate_baseline();
    });

    $("#indicator_modal_content").on("input", "#id_baseline", function(e){
        $("#id_baseline_na").prop('checked', false);
    });

    $("#indicator_modal_content").on("change", "#id_baseline_na", function(e){
        $("#id_baseline").val('');
        if (!$(this).is(':checked')){
            validate_baseline()
        } else {
            reset_baseline_errors();
        }
    });

    $("#indicator_modal_content").on("blur", "#id_target_frequency_custom", function(e){
        var is_valid = validateForEmptyField("id_target_frequency_custom");
        if (!is_valid) {
          $("#div_id_target_frequency_custom").addClass('mb-5')
          $("#div_id_target_frequency_custom").removeClass('mb-3')
        }
        else {
          $("#div_id_target_frequency_custom").addClass('mb-3')
          $("#div_id_target_frequency_custom").removeClass('mb-5')
        }
    });

    $("#indicator_modal_content").on("blur", "#id_target_frequency_num_periods", function(e){
        validateNumPeriods();

    });

    $("#indicator_modal_content").on("blur", "#id_name", function(e){
        var is_valid = validateForEmptyField("id_name");
        if (!is_valid) {
          $("#div_id_name").addClass('marginbottom-225')
          $("#div_id_name").removeClass('mb-3')
        }
        else {
          $("#div_id_name").addClass('mb-3')
          $("#div_id_name").removeClass('marginbottom-225')
        }
    });

    // Allow users to click an IPTT table row to highlight it
    $("#iptt_table tbody tr").on("click", function(e){
        // Don't highlight the row if the user is clicking on the popup or gear icons
        if(!['BUTTON', 'path', 'svg', 'a'].includes(e.target.tagName)) {
            if ($(this).hasClass('row-highlight')){
                $("#iptt_table tbody tr").removeClass('row-highlight');
            }
            else{
                $("#iptt_table tbody tr").removeClass('row-highlight');
                $(this).addClass('row-highlight');
            }
        }
    })

    function scrollToIndicatorFormBottom() {
        // Handle either full page form or modal
        let $el = $('#indicator_modal_div').length ? $('#indicator_modal_div') : $('html');
        scrollToBottom($el);
    }

    /*
     * Change tracking functions
     */

    // Returns an array of objects of periodic target form values
    // can be called with a row to exclude from the list (to check if _other_ targets have changed)
    function getFormPeriodicTargets(excluded_row=null) {
        let periodic_targets = [];

        // Collect all existing periodic_targets into an array.
        $('#periodic_targets_table tbody tr.periodic-target').each(function () {
            let $this = $(this);
            if (excluded_row === null || excluded_row[0] !== $this[0]) {
                let eventNameElement = $($this.find('input[type=text]'));
                let targetValueSelector = $($this.find('input[type=number]'));
    
                let pt_id;
                let pt_name;
                try {
                    pt_id = parseInt(targetValueSelector.attr('id').split('-')[1]);
                    if (!$.isNumeric(pt_id)) {
                        pt_id = 0;
                    }
                } catch (err) {
                    pt_id = 0;
                }
    
                if (eventNameElement.length > 0) {
                    pt_name = eventNameElement.val();
                } else {
                    pt_name = targetValueSelector.attr('name');
                }
    
                let pt_value = targetValueSelector.val();
                let start_date = targetValueSelector.data("startDate");
                let end_date = targetValueSelector.data("endDate");
    
                periodic_targets.push({
                    'id': pt_id,
                    'period': pt_name,
                    'target': pt_value,
                    'start_date': start_date,
                    'end_date': end_date
                });
            }
        });

        return periodic_targets;
    }

    // return a JS obj of key/vals of indicator form
    function getIndicatorFormAsObject() {
        let $form = $('#indicator_update_form');
        let formObj = {};

        // Turns out this is not great as serializeArray() will return multiple objs for a single name
        // in the case of form fields with multiple values (like multi-selects)
        // This causes data loss to occur. I've left it for now as no TRACKED_FIELDS currently have multiple values
        // and hopefully this code will be redone soon anyways
        $form.serializeArray().forEach(function (x) {
            formObj[x.name] = x.value;
        });

        // Set is_cumulative if it's not already set
        // This is a null boolean in the DB. Django has:
        // 1: null
        // 2: true
        // 3: false
        if (formObj['is_cumulative'] === undefined) {
            formObj['is_cumulative'] = 3;
        }

        let periodic_targets = getFormPeriodicTargets();

        formObj['periodic_targets'] = $.isEmptyObject(periodic_targets) ? 'generateTargets' : JSON.stringify(periodic_targets);

        return formObj;
    }

    // same as getIndicatorFormAsObject() but containing only tracked fields
    // can be used to snapshot form state for later comparison
    function getTrackedFieldsObject() {
        let formObj = getIndicatorFormAsObject();
        let trackFieldsObj = {};

        Object.keys(formObj).forEach(function(key) {
            if (TRACKED_FIELDS.has(key)) {
                trackFieldsObj[key] = formObj[key];
            }
        });

        return trackFieldsObj;
    }

    // remember the initial state of tracked fields on the form
    function recordTrackedFieldsSnapshot() {
        initialTrackedFieldsFormState = getTrackedFieldsObject();
    }
        
    // update just the targets portion of the form object:
    function updateTargetSnapshot() {
        let periodic_targets = getFormPeriodicTargets();
        initialTrackedFieldsFormState.periodic_targets = $.isEmptyObject(periodic_targets) ? 'generateTargets' : JSON.stringify(periodic_targets);
    }

    // have any tracked fields changed in the form?
    function hasTrackedFieldsChanged() {
        let prevState = JSON.stringify(initialTrackedFieldsFormState);
        let currState = JSON.stringify(getTrackedFieldsObject());
        return prevState !== currState;
    }

    // have targets or target values changed in the form?
    function hasTargetsChanged() {
        let currTrackedFieldsFormState = getTrackedFieldsObject();

        // look at values of targets in table
        let prevTargetFieldsState = initialTrackedFieldsFormState.periodic_targets;
        let currTargetFieldsState = currTrackedFieldsFormState.periodic_targets;

        // LoP has not values, so look at changes in the target type itself
        let prevTargetType = initialTrackedFieldsFormState.target_frequency;
        let currTargetType = currTrackedFieldsFormState.target_frequency;

        return prevTargetFieldsState !== currTargetFieldsState || prevTargetType !== currTargetType;
    }
</script>
