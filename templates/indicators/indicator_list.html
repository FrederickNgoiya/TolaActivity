{% extends "base.html" %}
{% load i18n %}
{% block page_title %}{% trans "Program Indicators" %}{% endblock %}

{% block content %}

{% include "indicators/filter.html" %}
<br>
<div id="div-id-indicator-list">
    {% for program in programs %}
        <div class='card'>
            <div class='card-header d-flex justify-content-between align-items-center'>
                <span class="program-name">{{ program.name|truncatechars:185 }}</span>
                <span>
                    <a href="/indicators/indicator_create/{{ program.id }}/" roll="button" class="btn btn-link btn-white"><i class="fas fa-plus-circle"></i> {% trans "Add indicator" %}</a>
                </span>
            </div>
            {% if not program.indicator_set.all %}
                <div class='card-body'>
                    <div class="card-title">{% trans "No Indicators have been entered for this program" %}</div>
                    <p class="card-text">
                        {% trans "Add a new indicator via the" %}
                        <a href="/indicators/indicator_create/{{ program.id }}/">{% trans 'Add indicator' %}</a>
                        {% trans 'button above' %}.
                    </p>
                </div>
            {% else %}
                <div class='card-body d-flex justify-content-between align-items-center'>
                    <a
                        id="id_btnOpenindicatorsForProgramId_{{ program.id }}"
                        href="#"
                        onclick="loadIndicators({{ program.id }}, {{ indicator_id }}, {{ type_id }})"
                        class="btn btn-link btn-indicator-expand"
                        data-toggle="collapse"
                        data-target="#hidden-{{ program.id }}">
                            <!-- Need the div to make ensure rotating symbol doesn't push text to the right -->
                            <div class="div-expand-symbol"><i class="fas fa-caret-right"></i></div>
                            {{ program.indicator_count }}
                            {% if program.indicator_count == 1 %}
                                {% trans "program indicator" %}
                            {% else %}
                                {% trans "program indicators" %}
                            {% endif %}
                    </a>
                    <span class="small d-flex align-items-center">
                        <strong>
                            <a class="pr-1" href="/indicators/program_report/{{ program.id }}/">Indicator Plan</a>
                        </strong>
                        |
                        <strong>
                            <a class="pl-1" href="#" data-toggle="modal" data-target="#id_reporting_period_modal">
                                Reporting Period
                            </a>
                        </strong>
                    </span>
                </div>
                <div id="hidden-{{ program.id }}" class="collapse">
                    {% include "indicators/program_indicators_table.html" %}
                </div>
            {% endif %}
        </div>
        <br>
    {% empty %}
        <p>{% trans "No Programs" %}</p>
    {% endfor %}
</div>

<div class="modal fade" role="dialog" id="conform_modal_div" aria-labelledby="mySmallModalLabel">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">{% trans "Warning" %}</h4>
            </div>
            <div class="modal-body" id="confirm_modal_body">
                {% trans "Are you sure?" %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="modal-btn-yes">{% trans "Yes" %}</button>
                <button type="button" class="btn btn-primary" id="modal-btn-no">{% trans "No" %}</button>
            </div>
        </div>
    </div>
</div>


<div id="indicator_modal_div" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="indicator_modal_content">

        </div> <!-- modal content -->
    </div>
</div>


<div id="indicator_collecteddata_div" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="indicator_collecteddata_content">
            <div class="modal-body" id="indicator_modal_body" style="padding-top:10px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <span id = "modalmessages"></span>
                <div id="indicator_collected_data_modal_content"></div>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="tolatablemodal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        </div> <!-- /.modal-content -->
    </div> <!-- /.modal-dialog -->
</div> <!-- /.modal -->

<div id="id_reporting_period_modal" class="modal fade" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="reporting_period_content">
            <div class="modal-body ml-4 mb-3" id="reporting_period_body" style="padding-top:10px">
                <div class="mb-4">
                    <div class="pt-3" style="display:inline-block; width: 90%">
                        <div class="mb-4"><h2>Reporting period</h2></div>
                        <span>The program reporting period is used in the setup of periodic targets and in Indicator Performance Tracking Tables (IPTT). TolaActivity initially sets the reporting period to include the program’s official start and end dates, as recorded in the Grant and Award Information Tracker (GAIT) system. The reporting period may be adjusted to align with the program’s indicator plan.</span>
                    </div>
                    <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        style="display:inline-block;"
                        aria-label="Close">
                        <span class="x-modal">&times;</span>
                    </button>
                </div>
                <div id="div-gait-dates" class="mb-3">
                    <div class="mb-3">
                        <h3>GAIT program dates</h3>
                    </div>
                    <div style="display:inline-block;">
                        <div
                            id="gait_start_date"
                            class="mr-4"
                            style="display: inline-block;">
                                <h4 class="mb-0">START DATE</h4>
                                <h4>Dec 22, 2018</h4>
                        </div>
                        <div id="gait_start_date" style="display: inline-block;">
                            <h4 class="mb-0">END DATE</h4>
                            <h4>Dec 22, 2020</h4>
                        </div>
                    </div>
                </div>
                <div class="card inputs-in-a-box" id="div-card-user-dates" style="width: 90%">
                    <div class="card-body p-4">
                        <div>
                            <h3>Reporting start and end dates</h3>
                        </div>
                        <div>
                            <div
                                id="gait_start_date"
                                class="mr-5"
                                style="display: inline-block;">
                                    <h4 class="mb-0">START DATE</h4>
                                    <h4>Dec 22, 2018</h4>
                            </div>
                            <div id="gait_start_date" style="display: inline-block;">
                                <h4 class="mb-0">END DATE</h4>
                                <h4>Dec 22, 2020</h4>
                            </div>
                        </div>
                        <div>
                            While a program may begin and end any day of the month, reporting periods must begin on the first day of the month and end on the last day of the month. Please note that the reporting start month can only be adjusted <span class="color-red">before targets are set up and a program begins submitting performance results.</span> The reporting end month can still be extended.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    /*
    *  Load the collected data for an indicator on the results page
    */
    function loadCollected(indicator,program){
        var url = '/indicators/collected_data_table/' + indicator + '/' + program + '/';
        var div_name = '#hidden-indicator-' + indicator;
        $(div_name).empty();
        $.get(url, function(data){
            $(div_name).html(data);
            $("body").removeClass("modal-open");
        });
        $("#id_indicator_data_count_btn_"+indicator).blur();
    };

    /*
    *  Load the collected data for an indicator on the results page
    */
    function loadIndicators(program, indicator, type){
        $.get('/indicators/program_indicators/' + program + '/' + indicator + '/' + type + '/', function(data){
            $('#hidden-' + program).html(data);
            $("body").removeClass("modal-open");
          });

        let icon = $(`#id_btnOpenindicatorsForProgramId_${program}`).find("svg");
        if (icon.hasClass('fa-caret-right')) {
          icon.attr('class', 'fa-caret-down');
        } else {
          icon.attr('class', 'fa-caret-right');
        }
    };

    $("#indicator_collecteddata_div").on("click", "#targetsTabLink", function(e){
        e.preventDefault();
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();
        var url = $(e.target).parent().attr('href');
        $("#indicator_collecteddata_div").modal('hide');
        $("#indicator_modal_content").load(url+"?modal=1&targetsonly=true");
        $("#indicator_modal_div").modal('show');
    });

    $("#indicator_modal_div").on("click", "#backToCollectedDataLink", function(e){
        e.preventDefault();
        $("#indicator_modal_div").modal('hide');
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();
        $("#indicator_collecteddata_div").modal('show');

        var url = $(e.target).attr('href') + '?existingTargetsOnly=true';
        $.getJSON(url, function( data ) {
            $("#id_periodic_target").children('option:not(:first)').remove();
            $.each(data, function(index, pt) {
                $("#id_periodic_target")
                    .append($("<option></option>")
                    .attr("value", pt.id)
                    .text(pt.period + " (" + formatDate(pt.start_date) + " - " +  formatDate(pt.end_date) + ")"));
            });
            $("#id_periodic_target").trigger('change');
        });
    });


    $('#indicator_modal_div').on('hide.bs.modal', function (e) {
        try {
            var form = $(this).find('form');
            var program_id = parseInt($(this).find('form #id_program').val()[0]);
            var form_action = form.attr('action').split('/');
            var indicator_id = parseInt(form_action[form_action.length -2]);

            var targetsactive = $(this).find("#indicator_modal_body").data("targetsactive");
            var indicatorchanged = form.data('indicatorchanged');

            if (form.data('update_indicator_row') == 1) {
                var indicator_type = form.find("#id_indicator_type option:selected").text();
                var indicator_level = '';
                form.find("#id_level option:selected").each(function() {
                    indicator_level += $(this).text() + ', ';
                });
                var indicator_name = form.find("#id_name").val();
                var indicator_number = form.find("#id_number").val();
                var indicator_sector = form.find("#id_sector option:selected").text();
                $("#id_indicator_type_" + indicator_id).text(indicator_type);
                $("#id_indicator_level_" + indicator_id).text(indicator_level.trim().slice(0, -1));
                $("#id_indicator_name_" + indicator_id + " a").text(indicator_name);
                $("#id_indicator_number_" + indicator_id).text(indicator_number);
                $("#id_indicator_sector_" + indicator_id).text(indicator_sector);
            }

            if (targetsactive == 'true' || indicatorchanged == true) {
                loadCollected(indicator_id, program_id);
                // $("#hidden-indicator-"+indicator_id).collapse('show');
            }
        } catch (err){
            console.log(err);
        }
    });


    $('#indicator_collecteddata_div').on('hide.bs.modal', function (e) {
        var recordchanged = $(this).find('form').data('recordchanged');
        if (recordchanged == true) {
            var program_id = $(this).find('form #id_program').val();
            var indicator_id = $(this).find('form #id_indicator').val();
            loadCollected(indicator_id, program_id);
        }
    })

    // Open the CollectDataUpdate form in a modal
    $("#div-id-indicator-list").on("click", ".collecteddata-link", function(e) {
        e.preventDefault();
        var url = $(this).attr("href");
        url += "?modal=1";
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();

        $("#indicator_collected_data_modal_content").load(url);
        $("#indicator_collecteddata_div").modal('show');
    });


    // Open the IndicatorUpdate Form in a modal
    $("#div-id-indicator-list").on("click", ".indicator-link", function(e) {
        e.preventDefault();
        var url = $(this).attr("href");
        url += "?modal=1";
        var tab = $(this).data("tab");
        if (tab && tab != '' && tab != undefined && tab != 'undefined') {
            url += "&targetsactive=true";
        }
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();

        $("#indicator_modal_content").load(url);
        $("#indicator_modal_div").modal('show');

    });


    function getUrl() {
        var programId = $("#program_filter_value").data('programid');
        var indicatorId = $("#indicator_filter_value").data('indicatorid');
        var typeId = $("#type_filter_value").data('typeid');
        var url = '/indicators/home/';

        url += (parseInt(programId) >= 0 ? programId : 0) + '/';
        url += (parseInt(indicatorId) >= 0 ? indicatorId : 0) + '/';
        url += (parseInt(typeId) >= 0 ? typeId : 0 ) + '/';
        return url;
    }
    $("#id_filtersDropdown").on("programFilterUpdated", "#id_programs_filter_dropdown", function(e){
        var url = getUrl();
        window.location.href = url;
    });

    $("#id_filtersDropdown").on("indicatorFilterUpdated", "#id_indicators_filter_dropdown", function(e){
        var url = getUrl();
        sessionStorage.setItem("openProgram", "true");
        window.location.href = url;
    });


    $("#id_filtersDropdown").on("indicatorTypeFilterUpdated", "#id_indicatortypes_filter_dropdown", function(e){
        var url = getUrl();
        window.location.href = url;
    });

    window.onload = function() {
        var programId = `{{ programs.0.id }}`;

        if (sessionStorage.getItem('openProgram')) {
            sessionStorage.removeItem("openProgram");
            loadIndicators(programId, indicatorId, 0);
            $("#hidden-"+programId).collapse('show');
        }
    }
 </script>
{% include 'indicators/indicator_form_common_js.html' %}
{% include 'indicators/collecteddata_form_common_js.html' %}
{% endblock content %}
