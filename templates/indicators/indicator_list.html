{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Program indicators" %} | {% endblock %}
{% block page_title %}{% trans "Program indicators" %}{% endblock %}

{% block content %}

{% include "indicators/filter.html" %}
<br>
<div id="div-id-indicator-list">
    {% for program in programs %}
        <div class='card border-0'>
            <div class='card-header d-flex justify-content-between align-items-center'>
                <span class="program-name fontsize-130">{{ program.name|truncatechars:140 }}</span>
                {% if program.reporting_period_start and program.reporting_period_end %}
                    <span>
                        <a href="{% url 'indicator_create' program.id %}" role="button" class="btn btn-link btn-white"><i class="fas fa-plus-circle"></i> {% trans "Add indicator" %}</a>
                    </span>
                {% endif %}
            </div>
            <div class='card-body d-flex justify-content-between align-items-center'>
                {% if not program.reporting_period_start or not program.reporting_period_end %}
                    <div class="card-title paddingleft-125 m-0 fontsize-130">
                        {% trans "Before adding indicators and performance results, we need to know your program's " %}
                        <a
                            class="pl-1"
                            href="#"
                            data-toggle="modal"
                            data-program="{{ program.id }}"
                            data-progstart="{{ program.start_date }}"
                            data-progend="{{ program.end_date }}"
                            data-rptstart="{{ program.reporting_period_start }}"
                            data-rptend="{{ program.reporting_period_end }}"
                            data-target="#id_reporting_period_modal">
                                {% trans "reporting start and end dates." %}
                        </a>
                    </div>
                {% elif not program.indicator_set.all %}
                    <div class="card-title paddingleft-125 m-0 fontsize-130">{% trans "No Indicators have been entered for this program" %}</div>
                {% else %}
                    <a
                        id="id_btnOpenindicatorsForProgramId_{{ program.id }}"
                        href="#"
                        onclick="loadIndicators({{ program.id }}, {{ indicator_id }}, {{ type_id }})"
                        class="fontsize-130 btn btn-link p-0 font-weight-normal"
                        data-toggle="collapse"
                        data-target="#hidden-{{ program.id }}">
                            <!-- Need the div to make ensure rotating symbol doesn't push text to the right -->
                            <div class="div-expand-symbol"><i class="fas fa-caret-right"></i></div>
                            {{ program.indicator_count }}
                            {% if program.indicator_count == 1 %}
                                {% trans "program indicator" %}
                            {% else %}
                                {% trans "program indicators" %}
                            {% endif %}
                    </a>
                {% endif %}
                {% if program.reporting_period_start and program.reporting_period_end %}
                    <span class="d-flex align-items-center">
                        <a class="pr-1" href="{% url 'programIndicatorReport' program.id %}">{% trans 'Indicator plan' %}</a>
                        |
                        <a
                            id="id_link_reporting_period_{{program.id}}"
                            class="pl-1"
                            href="#"
                            data-toggle="modal"
                            data-program="{{ program.id }}"
                            data-progstart="{{ program.start_date }}"
                            data-progend="{{ program.end_date }}"
                            data-rptstart="{{ program.reporting_period_start }}"
                            data-rptend="{{ program.reporting_period_end }}"
                            data-target="#id_reporting_period_modal">
                                {% trans 'Reporting period' %}
                        </a>
                    </span>
                {% endif %}
            </div>
            {% if program.does_it_need_additional_target_periods is True %}
                <span id="id_missing_targets_msg" class="color-red fontsize-85 missing_targets_msg">
                    <i class="fas fa-bullseye"></i>&nbsp;
                    {% trans 'Some indicators have missing targets. To enter these values, click the target icon near the indicator name.' %}
                </span>
            {% endif %}
            {% if program.indicator_set.all %}
                <div id="hidden-{{ program.id }}" class="collapse">
                    {% include "indicators/program_indicators_table.html" %}
                </div>
            {% endif %}

        </div>
        <br>
    {% empty %}
        <p>{% trans "No Programs" %}</p>
    {% endfor %}
</div>

{% include "indicators/indicator_list_modals.html" %}

<script type="javascript">
    // Filters
    function getUrl() {
        var programId = $("#program_filter_value").data('programid');
        var indicatorId = $("#indicator_filter_value").data('indicatorid');
        var typeId = $("#type_filter_value").data('typeid');
        var url = '/indicators/home/';

        url += (parseInt(programId) >= 0 ? programId : 0) + '/';
        url += (parseInt(indicatorId) >= 0 ? indicatorId : 0) + '/';
        url += (parseInt(typeId) >= 0 ? typeId : 0 ) + '/';
        return url;
    }
    $("#id_filtersDropdown").on("programFilterUpdated", "#id_programs_filter_dropdown", function(e){
        var url = getUrl();
        window.location.href = url;
    });

    $("#id_filtersDropdown").on("indicatorFilterUpdated", "#id_indicators_filter_dropdown", function(e){
        var url = getUrl();
        sessionStorage.setItem("openProgram", "true");
        window.location.href = url;
    });


    $("#id_filtersDropdown").on("indicatorTypeFilterUpdated", "#id_indicatortypes_filter_dropdown", function(e){
        var url = getUrl();
        window.location.href = url;
    });

    window.onload = function() {
        var programId = `{{ programs.0.id }}`;

        if (sessionStorage.getItem('openProgram')) {
            sessionStorage.removeItem("openProgram");
            loadIndicators(programId, indicatorId, 0);
            $("#hidden-"+programId).collapse('show');
        }
    }
 </script>
{% include 'indicators/indicator_form_common_js.html' %}
{% include 'indicators/collecteddata_form_common_js.html' %}
{% endblock content %}
