{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Program indicators" %} | {% endblock %}
{% block page_title %}{{ program.name }}{% endblock %}

{% block content %}
    <div class="program__calendar-complete">
        Program period is {{ percent_complete }}% complete
    </div>

    {% if indicator_count %}
        <div class="program__status-gauges">

            <div class="status-gauge">
                <div class="gauge__graphic--performance-band">
                    [performance-band]
                </div>
                <div class="gauge__value">
                    50%
                </div>
                <div class="gauge__label">
                    {% trans 'Indicators on track' %}
                </div>
                <div class="gauge__detail">
                    20% are >15% above target
                </div>
                <div class="gauge__detail">
                    30% are >15% below target
                </div>
            </div>

            <div class="status-gauge">
                <div class="gauge__graphic--tank">
                    [tank]
                </div>
                <div class="gauge__value">
                    50%
                </div>
                <div class="gauge__label">
                    {% trans 'indicators have targets defined' %}
                </div>
                <div class="gauge__detail">
                    12% of indicators have no targets
                </div>
            </div>

            <div class="status-gauge">
                <div class="gauge__graphic--tank">
                    [tank]
                </div>
                <div class="gauge__value">
                    50%
                </div>
                <div class="gauge__label">
                    {% trans 'Indicators have reported results' %}
                </div>
                <div class="gauge__detail">
                    35% of indicators have no results
                </div>
            </div>

            <div class="status-gauge">
                <div class="gauge__graphic--tank">
                    [tank]
                </div>
                <div class="gauge__value">
                    50%
                </div>
                <div class="gauge__label">
                    {% trans 'Results are backed up with evidence' %}
                </div>
                <div class="gauge__detail">
                    65% of results are missing evidence
                </div>
            </div>

        </div>
    {% endif %}

<div class="program-page__main">
    <div class="program-page__details">
        Side Panel
    </div>
    <div id="div-id-indicator-list" class="program-page__indicators">
        {# filter goes here ? #}
        {% comment %} #}
        <div class="program__filters"> {# TODO: this wrapper should be in the filters include #}
            {% include "indicators/filter2.html" %}
        </div>
        {% endcomment %}
        {% include "indicators/program_indicators_table.html" %}
    </div>
</div>
<div class="modal fade" role="dialog" id="conform_modal_div" aria-labelledby="mySmallModalLabel">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">{% trans "Warning" %}</h4>
            </div>
            <div class="modal-body" id="confirm_modal_body">
                {% trans "Are you sure?" %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="modal-btn-yes">{% trans "Yes" %}</button>
                <button type="button" class="btn btn-primary" id="modal-btn-no">{% trans "No" %}</button>
            </div>
        </div>
    </div>
</div>


<div id="indicator_modal_div" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="indicator_modal_content">

        </div> <!-- modal content -->
    </div>
</div>


<div id="indicator_collecteddata_div" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="indicator_collecteddata_content">
            <div class="modal-body" id="indicator_modal_body" style="padding-top:10px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <span id = "modalmessages"></span>
                <div id="indicator_collected_data_modal_content"></div>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="tolatablemodal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        </div> <!-- /.modal-content -->
    </div> <!-- /.modal-dialog -->
</div> <!-- /.modal -->

{% include 'indicators/indicator_reportingperiod_modal.html'%}

<script type="text/javascript">
    /*
    *  Load the collected data for an indicator on the results page
    */
    function loadCollected(indicator,program){
        let url = "{% url "collected_data_view" 0 0 %})"
        url = url.replace(/0\/0\//, indicator + "/" + program + "/")
        var div_name = '#hidden-indicator-' + indicator;
        $(div_name).empty();
        $.get(url, function(data){
            $(div_name).html(data);
            $("body").removeClass("modal-open");
        });
        $("#id_indicator_data_count_btn_"+indicator).blur();
    };

    /*
    *  Load the collected data for an indicator on the results page
    */
    function loadIndicators(program, indicator, type){
        $.get('/indicators/program_indicators/' + program + '/' + indicator + '/' + type + '/', function(data){
            $('#hidden-' + program).html(data);
            $("body").removeClass("modal-open");
          });

        let icon = $(`#id_btnOpenindicatorsForProgramId_${program}`).find("svg");
        if (icon.hasClass('fa-caret-right')) {
          icon.attr('class', 'fa-caret-down');
        } else {
          icon.attr('class', 'fa-caret-right');
        }
    };

    $("#indicator_collecteddata_div").on("click", "#targetsTabLink", function(e){
        e.preventDefault();
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();
        var url = $(e.target).parent().attr('href');
        $("#indicator_collecteddata_div").modal('hide');
        $("#indicator_modal_content").load(url+"?modal=1&targetsonly=true");
        $("#indicator_modal_div").modal('show');
    });

    $("#indicator_modal_div").on("click", "#backToCollectedDataLink", function(e){
        e.preventDefault();
        $("#indicator_modal_div").modal('hide');
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();
        $("#indicator_collecteddata_div").modal('show');

        var url = $(e.target).attr('href') + '?existingTargetsOnly=true';
        $.getJSON(url, function( data ) {
            $("#id_periodic_target").children('option:not(:first)').remove();
            $.each(data, function(index, pt) {
                $("#id_periodic_target")
                    .append($("<option></option>")
                    .attr("value", pt.id)
                    .text(pt.period + " (" + formatDate(pt.start_date) + " - " +  formatDate(pt.end_date) + ")"));
            });
            $("#id_periodic_target").trigger('change');
        });
    });

    $('#indicator_modal_div').on('hide.bs.modal', function (e) {
        var form = $(this).find('form');
        var url = form.attr("action");
        // make a get request to the server to unset the target_frequency if user
        // closed has not yet created periodic_targets.
        // $.get(url);

        try {

            var program_id = parseInt($(this).find('form #id_program').val());
            var form_action = form.attr('action').split('/');
            var indicator_id = parseInt(form_action[form_action.length -2]);
            var kpi = form.find("#id_key_performance_indicator").prop("checked");

            var targetsactive = $(this).find("#indicator_modal_body").data("targetsactive");
            var indicatorchanged = form.data('indicatorchanged');

            if (form.data('update_indicator_row') == 1) {
                var indicator_type = form.find("#id_indicator_type option:selected").text();
                var indicator_level = '';
                form.find("#id_level option:selected").each(function() {
                    indicator_level += $(this).text() + ', ';
                });

                var indicator_number = form.find("#id_number").val();
                var indicator_name = `${indicator_number} ${form.find("#id_name").val()}`;

                if (kpi) {
                    if ($("#id_indicator_name_" + indicator_id + " span.badge").length == 0) {
                        $("#id_indicator_name_" + indicator_id).append("<span class='badge'>KPI</span>");
                    } else {
                        $("#id_indicator_name_" + indicator_id + " span.badge").text("KPI");
                    }
                } else {
                    $("#id_indicator_name_" + indicator_id + " span.badge").text("");
                }
                var indicator_sector = form.find("#id_sector option:selected").text();
                $("#id_indicator_type_" + indicator_id).text(indicator_type);
                $("#id_indicator_level_" + indicator_id).text(indicator_level.trim().slice(0, -1));
                $("#id_indicator_name_" + indicator_id + " a .indicator_name").text(indicator_name);
                $("#id_indicator_sector_" + indicator_id).text(indicator_sector);
                $("#id_indicator_unit_" + indicator_id).text(form.find("#id_unit_of_measure").val());
                $("#id_indicator_baseline_" + indicator_id).text(form.find("#id_baseline").val());
                $("#id_indicator_target_" + indicator_id).text(form.find("#id_lop_target").val());
            }

            // update the results table
            loadCollected(indicator_id, program_id);

        } catch (err){
            console.log(err);
        }
    });


    $('#indicator_collecteddata_div').on('hide.bs.modal', function (e) {
        var recordchanged = $(this).find('form').data('recordchanged');
        if (recordchanged == true) {
            var program_id = $(this).find('form #id_program').val();
            var indicator_id = $(this).find('form #id_indicator').val();
            loadCollected(indicator_id, program_id);
        }
    })

    // Open the CollectDataUpdate form in a modal
    $("#div-id-indicator-list").on("click", ".collecteddata-link", function(e) {
        e.preventDefault();
        var url = $(this).attr("href");
        url += "?modal=1";
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();

        $("#indicator_collected_data_modal_content").load(url);
        $("#indicator_collecteddata_div").modal('show');
    });


    // Open the IndicatorUpdate Form in a modal
    $("#div-id-indicator-list").on("click", ".indicator-link", function(e) {
        e.preventDefault();
        var url = $(this).attr("href");
        url += "?modal=1";
        var tab = $(this).data("tab");
        if (tab && tab != '' && tab != undefined && tab != 'undefined') {
            url += "&targetsactive=true";
        }
        $("#indicator_modal_content").empty();
        $("#modalmessages").empty();

        $("#indicator_modal_content").load(url);
        $("#indicator_modal_div").modal('show');

    });

    function getUrl() {
        var programId = new URL(window.location.href).pathname.split("/")[2];
        var indicatorId = $("#indicator_filter_value").data('indicatorid');
        var typeId = $("#type_filter_value").data('typeid');
        var url = '/program/';

        url += (parseInt(programId) >= 0 ? programId : 0) + '/';
        url += (parseInt(indicatorId) >= 0 ? indicatorId : 0) + '/';
        url += (parseInt(typeId) >= 0 ? typeId : 0 ) + '/';
        return url;
    }

    $("#id_filtersDropdown").on("indicatorFilterUpdated", "#id_indicators_filter_dropdown", function(e){
        var url = getUrl();
        sessionStorage.setItem("openProgram", "true");
        window.location.href = url;
    });


    $("#id_filtersDropdown").on("indicatorTypeFilterUpdated", "#id_indicatortypes_filter_dropdown", function(e){
        var url = getUrl();
        window.location.href = url;
    });


 </script>
{% include 'indicators/indicator_form_common_js.html' %}
{% include 'indicators/collecteddata_form_common_js.html' %}
{% endblock content %}
