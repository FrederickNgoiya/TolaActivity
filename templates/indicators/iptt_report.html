{% extends "base.html" %}
{% load widget_tweaks %}
{% load i18n %}
{% load mytags %}
{% block title %}Indicator Performance Tracking Table{% endblock %}
{% block page_title %}{% endblock %}
{% block bodyclasses %}iptt-table{% endblock %}

{% block content %}
<style>
  .popover{
    max-width: 100%; /* Max Width of the popover (depending on the container) */
  }
</style>
  <div class="float-left collapse width show" id="sidebar">
    {% include 'indicators/iptt_filter_form.html' %}
  </div>
  <div class="sidebar-toggle" style="">
    <a href="#" data-target="#sidebar" data-toggle="collapse" style="" title="Show/hide filters">
      <i class="fa fa-chevron-left"></i>
    </a>
  </div>
  <main class="col-md-9 float-left pt-1">
    <div id="id_div_top_iptt_report">
        <span id="id_span_iptt_date_range">
          <h2>Indicator Performance Tracking Table</h2>
          <strong>{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}</strong>
        </span>
        <table id="iptt_table" class="table table-sm table-bordered table-hover" style="background-color: white;">
          <caption>Indicator Performance Tracking Table</caption>
          <colgroup scope="col" span="9"></colgroup>
          <colgroup scope="col" span="3" class="lopCols"></colgroup>
          <colgroup scope="col" span="{{ report_date_ranges|length }}"></colgroup>
          <thead class="thead-light">
          <tr>
            <td colspan="9" id="id_td_iptt_program_name" class="lopCols">
              <h5 style="margin-left:-5px;">
                  {{ program.name|wordwrap:100|linebreaks }}
              </h5>
            </td>
            <td scope="colgroup" colspan="3" style="vertical-align: bottom;" class="text-center">
              {% trans "LIFE OF PROGRAM" %}
            </td>
              {% for k, v in report_date_ranges.items %}
                <td scope="col"
                    {% if reporttype == 'targetperiods' %} colspan="3" {% endif %}
                    class="text-center lopCols" style="min-width: 180px;">
                  {{ k|upper }}<br>
                  {% if v.0 is not None and v.1 is not None %}
                    <small>{{ v.0|date:"M d, Y" }} - {{ v.1|date:"M d, Y" }}</small>
                  {% endif %}
                </td>
              {% endfor %}
          </tr>
          <tr>
            <th scope="col" style="min-width:80px">{% trans "NO." %}</th>
            <th scope="col" class="td-no-side-borders" style="min-width:600px">{% trans "INDICATOR" %}</th>
            <th scope="col" class="td-no-side-borders"></th>
            <th scope="col" style="min-width:90px">{% trans "LEVEL" %}</th>
            <th scope="col" style="min-width:250px">{% trans "UNIT OF MEASURE" %}</th>
            <th scope="col">{% trans "CHANGE" %}</th>
            <th scope="col" style="min-width:130px">{% trans "C / NC" %}</th>
            <th scope="col" style="min-width:50px">{% trans "# / %" %}</th>
            <th scope="col">{% trans "BASELINE" %}</th>
            <th scope="col" class="text-right td-no-side-borders" style="min-width: 110px;">{% trans "TARGET" %}</th>
            <th scope="col" class="text-right td-no-side-borders" style="min-width: 110px;">{% trans "ACTUAL" %}</th>
            <th scope="col" class="text-right td-no-side-borders" style="min-width: 110px;">{% trans "% MET" %}</th>
            {% if reporttype == 'targetperiods' %}
              {% for pt in report_date_ranges %}
                <th scope="col" class="text-right" style="min-width: 110px;">{% trans "TARGET" %}</th>
                <th scope="col" class="text-right" style="min-width: 110px;">{% trans "ACTUAL" %}</th>
                <th scope="col" class="text-right" style="min-width: 110px;">{% trans "% MET" %}</th>
              {% endfor %}
            {% else %}
              {% for _ in report_date_ranges.items %}
                <th scope="col" class="text-right">{% trans "ACTUAL" %}</th>
              {% endfor %}
            {% endif %}
          </tr>
          </thead>
          <tbody>
          {% for indicator in indicators %}
            <tr>
              <td class="td-no-side-borders">{{ indicator.number }}</td>
              <td class="td-no-side-borders">
                <button type="button"
                        class="btn btn-link p-1 indicator-ajax-popup indicator-data"
                        data-indicatorid={{indicator.id}}
                        data-container="body"
                        data-trigger="focus"
                        data-toggle="popover"
                        data-placement="right">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                {{ indicator.name }}
              </td>
              <td class="td-no-side-borders">
                <a href="{% url 'indicator_update' indicator.id %}"
                   data-programid="{{ program.id }}"
                   class="indicator-link float-right">
                  <i class="fas fa-cog"></i>
                </a>
              </td>
              <td class="td-no-side-borders">{{ indicator.lastlevel }}</td>
              <td class="td-no-side-borders">{{ indicator.unit_of_measure  }}</td>
              <td class="td-no-side-borders" align="right">{{ indicator.direction_of_change }}</td>
              <td class="td-no-side-borders">
                {{ indicator.is_cumulative }}
              </td>
              <td class="td-no-side-borders">{{ indicator.unittype }}</td>
              <td class="td-no-side-borders" align="right">
                {{ indicator.baseline }}
              </td>
              <td class="td-no-side-borders" align="right">
                {{ indicator.lop_target }}
              </td>
              <td class="td-no-side-borders" align="right">
                {{ indicator.lop_actual }}
              </td>

              <td class="td-no-side-borders" align="right">
                {{ indicator.lop_percent_met }}
              </td>
              {% if reporttype == 'targetperiods' %}
                {% for k,v in report_date_ranges.items %}
                  <td align="right" style="border-right: 0px;">
                    {% with k|concat_string:"_period_target" as target %}
                      {{ indicator|hash:target }}
                    {% endwith %}
                  </td>
                  <td align="right" style="border-left: 0px; border-right: 0px;">
                    {% with k|concat_string:"_actual" as actual %}
                      {{ indicator|hash:actual }}
                    {% endwith %}
                  </td>
                  <td align="right" style="border-left: 0px;">
                    {% with k|concat_string:"_percent_met" as percent_met %}
                      {{ indicator|hash:percent_met }}
                    {% endwith %}
                  </td>
                {% endfor %}
              {% else %}
                {% for k, v in report_date_ranges.items %}
                  <td align="right">
                    <!-- if it is a NUMBER indicator -->
                    {% if indicator.unit_of_measure_type == 1 %}
                      {% if indicator.is_cumulative is True %}
                        {% with k|concat_string:"_rsum" as sum %}
                          {{ indicator|hash:sum|floatformat:"-2"|default_if_none:'' }}
                        {% endwith %}
                      {% else %}
                        {% with k|concat_string:"_sum" as sum %}
                          {{ indicator|hash:sum|floatformat:"-2"|default_if_none:'' }}
                        {% endwith %}
                      {% endif %}
                      <!-- if indicator is a PERCENT idnicator -->
                    {% elif indicator.unit_of_measure_type == 2 %}
                      {% if indicator.is_cumulative == True %}
                        <!-- if it is PERCENT and CUMULATIVE indicator then show the last data record's value -->
                        {% with k|concat_string:"_last" as last %}
                          {% if indicator|hash:last is not None %}
                            {{ indicator|hash:last|floatformat:"-2"|default_if_none:'' }}%
                          {% endif %}
                        {% endwith %}
                      {% else %}
                        <!-- if it is a PERCENT and NON-CUMULATIVE indicator -->
                        {% with k|concat_string:"_avg" as avg %}
                          {% if indicator|hash:avg is not None %}
                            <small><abbr title='{% trans "Average" %}'>{% trans "avg." %}</abbr></small>
                            {{ indicator|hash:avg|floatformat:"-2"|default_if_none:'' }}%
                          {% endif %}
                        {% endwith %}
                      {% endif %}
                    {% endif %}
                  </td>
                {% endfor %}
              {% endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="indicator_modal_div" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content" id="indicator_modal_content">

          </div> <!-- modal content -->
        </div>
    </div>

    <script>
        // initialize popovers
        $(function () {
          $('button.indicator-ajax-popup').popover({ // [data-toggle="popover"]
            html: true,
            container: 'body',
            // trigger: "manual",
            "content": function () {
              const indicatorId = $(this).data('indicatorid');
              const url = `/indicators/collected_data_table/${indicatorId}/0/?edit=false`;
              const serverResponse = $.ajax({ url: url, dataType: 'html', async: false }).responseText;
              return serverResponse;
            }
          })
          // .click(function (e) {
          //   $(this).popover('toggle');
          // });
        })

        // Open the IndicatorUpdate Form in a modal
        $("#id_div_top_iptt_report").on("click", ".indicator-link", function (e) {
          e.preventDefault();
          let url = $(this).attr("href");
          url += "?modal=1";
          const programId = $(this).data("programid");

          $("#indicator_modal_content").empty();
          $("#modalmessages").empty();

          $("#indicator_modal_content").load(url);
          $("#indicator_modal_div").modal('show');

        });
      </script>

    {% include 'indicators/indicator_form_common_js.html' %}
  </main>
{% endblock content %}
