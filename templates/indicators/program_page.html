{% extends "base.html" %}
{% load i18n mathfilters mytags %}
{% block title %}{% trans "Program indicators" %} | {% endblock %}
{% block page_title %}{{ program.name }}{% endblock %}
{% block header_extras %}
    <div class="program__calendar-complete">
        <div class="fas fa-calendar"></div>
        <p>
        {% blocktrans %}Program period is <br><strong>{{ percent_complete }}% complete</strong>{% endblocktrans %}
        </p>
    </div>
{% endblock %}

{% block content %}


    {% if indicator_count %}
        <aside class="program__status-gauges">

            {% gauge_band program.scope_percents %}

            {% gauge_tank program.metrics.targets_defined "have targets defined" "have no targets" "Indicators with targets" "targets_defined" %}

            {% gauge_tank program.metrics.reported_results "have reported results" "have no results" "Indicators with results" "reported_results" %}

            {% gauge_tank program.metrics.results_evidence "have evidence" "are missing evidence" "Results with evidence" "results_evidence" %}

        </aside>
    {% endif %}

<div class="program-page__main">
    <div class="program-page__sidebar">
        <section class="sidebar__detail">
            <h3>{% trans "Program Details" %}</h3>
            <p><a href="#">{% trans "Indicator Plan" %}</a></p>
        </section>
        <section class="sidebar__detail">
            <h3>{% trans "Documents" %}</h3>
            <p><a href="#">{% trans "View program documents" %}</a></p>
            <a href="#" class="btn-add"><i class="fas fa-plus-circle"></i> {% trans "Add document" %}</a>
        </section>
        <section class="sidebar__detail">
            <h3>{% trans "Sites" %}</h3>
            <p><a href="#">{% trans "View Program Sites" %}</a></p>
            <a href="#" class="btn-add"><i class="fas fa-plus-circle"></i> {% trans "Add site" %}</a>
        </section>
        <section class="sidebar__detail">
            <h3>{% trans "Pinned Reports" %}</h3>
            <ul class="pinned-reports">
                {% for pr in pinned_reports %}
                    <li class="pinned-report">
                        <a href="{% url 'iptt_report' pr.program_id pr.report_type %}?{{ pr.query_string }}" class="pinned-report__link">
                            <h4>{% trans "IPTT:" %} {{ pr.name }}</h4>
                           {{ pr.date_range_str }}
                        </a>
                        {% if pr.id %}
                        <a href="#"
                           class="pinned-report__remove text-danger"
                           data-delete-pinned-report="{{ pr.id }}">
                            <i class="fa fa-times"></i>
                        </a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            <a href="{% url 'iptt_quickstart' %}?program_id={{ program.id }}" class="btn-add"><i class="fas fa-plus-circle"></i> {% trans "Create an IPTT report" %}</a>
        </section>
    </div>
    <div id="div-id-indicator-list" class="indicators-list program-page__indicators">
        <div class="indicators-list__header">
            <h3 class="no-bold">{% blocktrans %}{{ indicator_count }} indicators{% endblocktrans %}</h3>
            <div>
                <a href="{% url 'indicator_create' program.id %}" role="button" class="btn-link btn-add"><i class="fas fa-plus-circle"></i> {% trans "Add indicator" %}</a>
            </div>
        </div>
        {% include "indicators/program_indicators_table.html" %}
    </div>
</div>

{% include "indicators/indicator_list_modals.html" %}
{% include 'indicators/indicator_form_common_js.html' %}
{% include 'indicators/collecteddata_form_common_js.html' %}
{% endblock content %}


{% block extra_js_in_body %}
    <script>
        let jsContext = {{ js_context|js }};
    </script>

    <script>
        // On pinned report delete btn click
        $('[data-delete-pinned-report]').click(function (e) {
            e.preventDefault();

            let prId = $(this).data('deletePinnedReport');
            let pinnedReport = $(this).closest('.pinned-report');

            if (window.confirm(jsContext.delete_pinned_report_confirmation_msg)) {
                $.ajax({
                    type: "POST",
                    url: jsContext.delete_pinned_report_url,
                    data: {
                        pinned_report_id: prId,
                    },
                    success: function () {
                        pinnedReport.remove();
                    },
                    error: function () {
                        console.log('AJAX error')
                    }
                });
            }
        });
        function hide_row_factory(positive, target) {
            return function() {
                var this_show;
                if (target == "results_evidence") {
                    this_show = $(this).data('has-evidence') * positive;
                } else if (target == "reported_results") {
                    this_show = $(this).data('reported-results') * positive;
                } else if (target == "targets_defined") {
                    this_show = $(this).data('defined-targets') * positive;
                }
                if (this_show == -1) {
                    $(this).hide();
                    $(this).next().hide();
                } else  {
                    $(this).show();
                    $(this).next().show();
                }
            }
        }
        $(document).ready(function() {
           $('.graphic__tick').on('click', function(e) {
            e.preventDefault();
            var target, positive;
            target = $(this).data('target');
            positive = $(this).data('target-positive');
            if (positive === 0) {
                return;
            }
            callback = hide_row_factory(positive, target);
            $('.indicators-list__indicator-header').each(callback);
           });
        });
    </script>
{% endblock %}
