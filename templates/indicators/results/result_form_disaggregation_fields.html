{% load widget_tweaks %}
{% load i18n %}
{# disaggregation fields in result_form_modal.html #}
{# TODO: update design, test functionality #}
{# values supercede labels, so show labels if not values #}
{% for disaggregation_formset in disaggregation_forms %}
    <fieldset class="disaggregation-table">
        <a
           href="#" id="disaggregations_toggle_{{ forloop.counter0 }}" class="is-accordion-toggle btn btn-link"
           data-toggle="collapse" data-target="#disaggregations_fields_{{ forloop.counter0 }}"
           aria-expanded="false" aria-controls="disaggregations_fields_{{ forloop.counter0 }}">
            <i class="fas fa-caret-right"></i>{{ disaggregation_formset.disaggregation }}
        </a>
        <span id="sum-validation-warning-{{ disaggregation_formset.prefix }}" class="hidden inline-feedback invalid-feedback disaggregations-needs-attention">
            <i class="fas fa-exclamation-triangle"></i>{% trans "Needs attention" %}
        </span>
        <div class="collapse" id="disaggregations_fields_{{ forloop.counter0 }}">
            {{ disaggregation_formset.management_form }}
            <table class="table table-sm table-striped">
                <colgroup>
                    <col>
                    <col style="width: 200px">
                </colgroup>
                <thead>
                    <tr>
                        <th>{% trans "Disaggregation" %}</th>
                        <th>{% trans "Actual value" %}</th>
                    </tr>
                </thead>
                <tbody>
            {% for form in disaggregation_formset %}
                <tr class="form-input-row">
                    <td>{{form.label_pk}}{{form.value.label_tag }}</td>
                    <td class="value-cell {% if indicator.unit_of_measure_type == indicator.PERCENTAGE %}input-symbol-percent feedback-row{% endif %}" data-prefix="{{ disaggregation_formset.prefix }}">
                        {{ form.value|add_class:"form-control text-right" }}
                        <div class="invalid-feedback">
                            {% trans "Please enter a number greater than zero." %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            {% if indicator.unit_of_measure_type != indicator.PERCENTAGE %}
                <tr class="calculated-value">
                    <td>
                        {% trans "Sum" %}
                        <span class="float-right" style="display: none;" id="sum-validation-actions-{{ disaggregation_formset.prefix }}">
                            <a href="#" class="action-if-invalid update-actual-value-button">
                                <i class="fas fa-sync"></i>
                                {% trans "Update actual value" %}
                            </a>
                            <span class="action-if-invalid text-danger sum-difference">-100</span>
                        </span>
                    </td>
                    <td class="sum-value-cell">
                        <input disabled class="form-control no-validate" id="disaggregation_sum_{{ disaggregation_formset.prefix }}" />
                    </td>
                </tr>
            {% endif %}
            <tr class="calculated-value">
                <td>{% trans "Actual value" %}</td>
                <td class="actual-value-cell {% if indicator.unit_of_measure_type == indicator.PERCENTAGE %}input-symbol-percent{% endif %}">
                    <input disabled class="form-control" id="actual_value_{{ disaggregation_formset.prefix }}" />
                </td>
            </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">
                        <div id="sum-validation-{{ disaggregation_formset.prefix }}" class="invalid-feedback">
                            {% trans "The sum of disaggregated values does not match the actual value." %}
                        </div>
                    </td>
                </tr>
            </tfoot>
            </table>
            
        </div>
    </fieldset>
{% endfor %}

<script>
    // Collect all the form prefixes for the different formsets for validation:
    var disaggForms = [
        {% for disaggregation_formset in disaggregation_forms %}
            "{{ disaggregation_formset.prefix }}",
        {% endfor %}
    ];
    
    function validateSum($sum, prefix) {
        if ($sum.hasClass('no-validate')) {
            return;
        }
        if ($sum.val() == '' || !$sum.val()) {
            $sum.removeClass('is-invalid', 'is-valid');
            $(`#sum-validation-${prefix}`).hide();
            $(`#sum-validation-warning-${prefix}`).addClass('hidden');
            $(`#sum-validation-actions-${prefix}`).hide();
        } else if ($sum.val() != $('#id_achieved').val()) {
            $sum.removeClass('is-valid').addClass('is-invalid');
            $(`#sum-validation-${prefix}`).show();
            $(`#sum-validation-warning-${prefix}`).removeClass('hidden');
            $(`#sum-validation-actions-${prefix}`).show().find('.sum-difference').html($sum.val() - $('#id_achieved').val());
        } else {
            $sum.removeClass('is-invalid').addClass('is-valid');
            $(`#sum-validation-${prefix}`).hide();
            $(`#sum-validation-warning-${prefix}`).addClass('hidden');
            $(`#sum-validation-actions-${prefix}`).hide();
        }
    };

    function updateActual() {
        $('.actual-value-cell').each(function() {
            $( this ).children('input').val($('#id_achieved').val());
        });
        disaggForms.forEach(
            prefix => {
                validateSum($(`#disaggregation_sum_${prefix}`), prefix);
            }
        )
    };
    
    function updateActualButton(ev) {
        ev.preventDefault();
        $('#id_achieved').val($(ev.target).parents('tr.calculated-value').find('.sum-value-cell>input').val());
        updateActual();
    }

    $(function() {
        $('.update-actual-value-button').on('click', updateActualButton);
        updateActual();
        $('#id_achieved').on('change', updateActual);
        let unLocalizer = window.getNumberLocalizer({decimalPlaces: 2, display: false});
        let reLocalizer = window.getNumberLocalizer({decimalPlaces: 2, display: true});
        let getDVHandler = (prefix) => {
            let updateSum = () => {
                let sumValue = Array.from(
                    Array(parseInt($(`#id_${prefix}-TOTAL_FORMS`).val())).keys()
                ).map(
                    idx => {
                        return unLocalizer($(`#id_${prefix}-${idx}-value`).val());
                    }
                ).reduce((a, b) => a + b);
                if (sumValue == 0) {
                    $(`#disaggregation_sum_${prefix}`).val('').removeClass('is-invalid, is-valid');
                } else {
                    $(`#disaggregation_sum_${prefix}`).val(reLocalizer(sumValue)).removeClass('is-invalid').addClass('is-valid');
                }
                validateSum($(`#disaggregation_sum_${prefix}`), prefix);
            }
            updateSum();
            return (ev) => {
                let $valueCell = $(ev.target);
                let value = unLocalizer($valueCell.val());
                if ($valueCell.val() === '') {
                    $valueCell.removeClass('is-invalid, is-valid');
                    updateSum();
                } else if (!value || value < 0) {
                    $valueCell.addClass('is-invalid').removeClass('is-valid');
                    $(`#disaggregation_sum_${prefix}`).val('').removeClass('is-valid, is-invalid');
                } else {
                    $valueCell.val(reLocalizer($valueCell.val())).removeClass('is-invalid').addClass('is-valid');
                    updateSum();
                }
            }
        };
        $('td.value-cell').each(function() {
            // all disaggregated value cells should validate on change, and update their respective sum field
            $( this ).children('input').on('change', getDVHandler($( this ).data('prefix'))).each(function() {
                $( this ).val(reLocalizer($( this ).val()));
            });
       });
    });

    
    function validateDisaggregations() {
        let valid = true;
        $('.no-validate').removeClass('no-validate');
        updateActual();
        $('.disaggregation-table').find('.is-invalid').each(function() {
            valid = false;
        });
        return valid;
    }
</script>