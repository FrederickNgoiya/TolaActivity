{% load widget_tweaks %}
{% load i18n %}
{# disaggregation fields in result_form_modal.html #}
{# TODO: update design, test functionality #}
{# values supercede labels, so show labels if not values #}
{% for disaggregation_formset in disaggregation_forms %}
    <fieldset class="disaggregation-formset unvalidated" data-prefix="{{ disaggregation_formset.prefix }}">
        <span style="white-space: nowrap;">
            <a
               href="#" id="disaggregations_toggle_{{ forloop.counter0 }}" class="is-accordion-toggle btn btn-link collapsed"
               data-toggle="collapse" data-target="#disaggregations_fields_{{ forloop.counter0 }}"
               aria-expanded="false" aria-controls="disaggregations_fields_{{ forloop.counter0 }}">
                <i class="fas fa-caret-right"></i>{{ disaggregation_formset.disaggregation }}
            </a>
            <span class="formset-feedback invalid-feedback">
                <i class="fas fa-exclamation-triangle"></i>&nbsp;{% trans "Needs attention" %}
            </span>
        </span>
        
        <div class="collapse" id="disaggregations_fields_{{ forloop.counter0 }}">
            {{ disaggregation_formset.management_form }}
            <ul class="list-group form-rows-list-group">
                {% for disaggregation_form in disaggregation_formset %}
                <li class="list-group-item form-rows-list-group__form-row">
                    <div class="form-row__label">
                        {{disaggregation_form.label_pk}}{{disaggregation_form.value.label_tag }}
                    </div>
                    <div class="col-md-4{% if indicator.unit_of_measure_type == indicator.PERCENTAGE %} input-symbol-percent {% endif %}">
                        {{ disaggregation_form.value|add_class:"form-control text-right force-numeric-input disaggregated-value-cell" }}
                        <div class="invalid-feedback">
                            {% trans "Please enter a number greater than or equal to zero." %}
                        </div>
                    </div>
                </li>
                {% endfor %}
                {% if indicator.unit_of_measure_type != indicator.PERCENTAGE %}
                <li class="list-group-item form-rows-list-group__footer-row">
                    <div class="form-row__label">
                        {% trans "Sum" %}
                    </div>
                    <div class="float-right actions-container">
                        <div class="invalid-actions invalid-feedback">
                            <a href="#">
                                <i class="fas fa-sync"></i>&nbsp;&nbsp;{% trans "Update actual value" %}
                            </a>
                            <span class="sum-difference"></span>
                        </div>
                        <div class="value-cell sum-value-cell">
                        </div>
                    </div>
                </li>
                {% endif %}
                <li class="list-group-item form-rows-list-group__footer-row reference-row">
                    <div class="form-row__label">
                        {% trans "Actual value" %}
                    </div>
                    <div class="float-right">
                        <div class="value-cell actual-value-cell"></div>
                    </div>
                </li>
            </ul>
            <div class="bad-sum-feedback invalid-feedback">
                {% trans "The sum of disaggregated values does not match the actual value." %}
            </div>
        </div>
    </fieldset>
{% endfor %}

<script>
    // Collect all the form prefixes for the different formsets for validation:
    var disaggForms = [
        {% for disaggregation_formset in disaggregation_forms %}
            "{{ disaggregation_formset.prefix }}",
        {% endfor %}
    ];
    var percentageInput = {% if indicator.unit_of_measure_type == indicator.PERCENTAGE %}true{% else %}false{% endif %};
    
    function updateActuals() {
        let val = $('#id_achieved').numericVal();
        $('.actual-value-cell').displayVal(val, percentageInput);
        $('.disaggregation-formset').trigger('validateSum');
    }

    function validateDisaggregatedValue(ev) {
        $( this ).removeClass('is-invalid');
        if ($( this ).val() == '') {
            // user entered blank, do nothing
        } else if ($( this ).numericVal() === null || $(this).numericVal() < 0) {
            $( this ).addClass('is-invalid');
        }
        $( this ).parents('.disaggregation-formset').trigger('updateSum');
    }
    
    function updateSum(ev) {
        if( $( this ).find('.is-invalid').length > 0 ) {
            $( this ).find('.sum-value-cell').html('');
        } else {
            let prefix = $( this ).data('prefix');
            let values = Array.from(
                Array(parseInt($(`#id_${prefix}-TOTAL_FORMS`).val())).keys()
            ).map(
                idx => {
                    return $(`#id_${prefix}-${idx}-value`).numericVal();
                }
            );
            if (values.every(val => (val === false || val === null))) {
                // disaggregation is empty (all blank)
                $( this ).find('.sum-value-cell').html('');
            } else {
                let sumValue = values.filter(val => val > 0).reduce((a, b) => a + b);
                $( this ).find('.sum-value-cell').displayVal(sumValue, percentageInput);
            }
        }
        $( this ).trigger('validateSum');
        $( this ).trigger('validateFormset');
    }
    
    function validateSum() {
        if (!$( this ).find('.sum-value-cell')) {
            // percent cell - no sum validation
            return;
        }
        let $sumValueCell = $( this ).find('.sum-value-cell').first();
        $sumValueCell.parent().removeClass('no-sum-value').removeClass('bad-sum-value');
        let sumValue = $sumValueCell.numericVal();
        if (sumValue === false) {
            // sum value is not good:
            $sumValueCell.parent().addClass('no-sum-value');
        } else {
            let achievedValue = $('#id_achieved').numericVal();
            if (achievedValue != sumValue) {
                $sumValueCell.parent().addClass('bad-sum-value');
                $sumValueCell.parent().find('.sum-difference')
                    .html(`${achievedValue < sumValue ? '+' : ''}${$sumValueCell.toDisplayVal(sumValue - achievedValue)}`);
            }
        }
        $( this ).trigger('validateFormset');
    }
    function validateFormset() {
        $( this ).removeClass('has-errors');
        if ($( this ).find('.is-invalid').length > 0 ) {
            $( this ).addClass('has-errors');
        }
        if ($( this ).find('.bad-sum-value').length > 0) {
            $( this ).addClass('has-errors');
        }
    }
    
    function updateActualWithSum() {
        let sumValue = $( this ).parents('.actions-container').find('.sum-value-cell').first().html();
        $('#id_achieved').displayVal(sumValue);
        updateActuals();
        $('.disaggregation-formset').trigger('updateSum');
    }
    
    function validateDisaggregations() {
        $('.disaggregation-formset').removeClass('unvalidated').trigger('validateSum').trigger('validateFormset');
        if ($('.disaggregation-formset.has-errors').length > 0) {
            return false;
        }
        return true;
    }

    $(function() {
        // set initial actuals value:
        updateActuals();
        $('.disaggregated-value-cell').each(validateDisaggregatedValue);
        $('.disaggregation-formset').each(updateSum);
        // whenever the actual value changes, update the actual values in each disaggregation row:
        $('#id_achieved').on('change', updateActuals);
        // whenever any of the value fields change, validate the individual value field:
        // $('.disaggregated-value-cell').keydown(window.numberInputValidator).on('change', validateDisaggregatedValue);
        $('.disaggregated-value-cell').each(function() {
            window.getValidatedNumericInput(this).on('change', validateDisaggregatedValue);
        });
        $('.disaggregation-formset')
            .on('updateSum', updateSum)
            .on('validateSum', validateSum)
            .on('validateFormset', validateFormset)
        $('.invalid-actions>a').on('click', updateActualWithSum);
        
    });

    
    
</script>