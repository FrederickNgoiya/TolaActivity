{% load widget_tweaks %}
{% load i18n %}
{# disaggregation fields in result_form_modal.html #}
{# TODO: update design, test functionality #}
{# values supercede labels, so show labels if not values #}
{% for disaggregation_formset in disaggregation_forms %}
    <fieldset class="disaggregation-table">
        <a
           href="#" id="disaggregations_toggle_{{ forloop.counter0 }}" class="is-accordion-toggle btn btn-link"
           data-toggle="collapse" data-target="#disaggregations_fields_{{ forloop.counter0 }}"
           aria-expanded="false" aria-controls="disaggregations_fields_{{ forloop.counter0 }}">
            <i class="fas fa-caret-right"></i>{{ disaggregation_formset.disaggregation }}    
        </a>
        <span id="sum-validation-warning-{{ disaggregation_formset.prefix }}" class="inline-feedback invalid-feedback disaggregations-needs-attention">
            <i class="fas fa-exclamation-triangle"></i>{% trans "Needs attention" %}
        </span>
        <div class="collapse" id="disaggregations_fields_{{ forloop.counter0 }}">
            {{ disaggregation_formset.management_form }}
            <table class="table table-bordered table-sm table-hover table-striped">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
            {% for form in disaggregation_formset %}
                <tr>
                    <td>{{form.label_pk}}{{form.value.label_tag }}</td>
                    <td class="value-cell" data-prefix="{{ disaggregation_formset.prefix }}">
                        {{ form.value|add_class:"form-control" }}
                        <div class="invalid-feedback">
                            {% trans "Please enter a number greater than zero." %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <td>Sum</td>
                <td class="sum-value-cell">
                    <input disabled class="form-control" id="disaggregation_sum_{{ disaggregation_formset.prefix }}" />
                </td>
            </tr>
            <tr>
                <td>Actual value</td>
                <td class="actual-value-cell"><input disabled class="form-control" id="actual_value_{{ disaggregation_formset.prefix }}" /></td>
            </tr>
            </tbody>
            </table>
            <div id="sum-validation-{{ disaggregation_formset.prefix }}" class="invalid-feedback">
                {% trans "The sum of disaggregated values does not match the actual value." %}
            </div>
        </div>
    </fieldset>
{% endfor %}

<script>
    // Collect all the form prefixes for the different formsets for validation:
    var disaggForms = [
        {% for disaggregation_formset in disaggregation_forms %}
            "{{ disaggregation_formset.prefix }}",
        {% endfor %}
    ];

    

    $(function() {
        const validateSum = ($sum, prefix) => {
            if ($sum.val() == '' || !$sum.val()) {
                $sum.removeClass('is-invalid', 'is-valid');
                $(`#sum-validation-${prefix}`).hide();
                $(`#sum-validation-warning-${prefix}`).hide();
            } else if ($sum.val() != $('#id_achieved').val()) {
                $sum.removeClass('is-valid').addClass('is-invalid');
                $(`#sum-validation-${prefix}`).show();
                $(`#sum-validation-warning-${prefix}`).show();
            } else {
                $sum.removeClass('is-invalid').addClass('is-valid');
                $(`#sum-validation-${prefix}`).hide();
                $(`#sum-validation-warning-${prefix}`).hide();
            }
        };
        const updateActual = () => {
            $('.actual-value-cell').each(function() {
                $( this ).children('input').val($('#id_achieved').val());
            });
            disaggForms.forEach(
                prefix => {
                    validateSum($(`#disaggregation_sum_${prefix}`), prefix);
                }
            )
        };
        
        updateActual();
        $('#id_achieved').on('change', updateActual);
        
        let getDVHandler = (prefix) => {
            let updateSum = () => {
                let sumValue = Array.from(
                    Array(parseInt($(`#id_${prefix}-TOTAL_FORMS`).val())).keys()
                ).map(
                    idx => {
                        let valueField = $(`#id_${prefix}-${idx}-value`);
                        return !isNaN(parseFloat(valueField.val())) ? parseFloat(valueField.val()) : 0;
                    }
                ).reduce((a, b) => a + b);
                if (sumValue == 0) {
                    $(`#disaggregation_sum_${prefix}`).val('').removeClass('is-invalid, is-valid');
                } else {
                    $(`#disaggregation_sum_${prefix}`).val(sumValue).removeClass('is-invalid').addClass('is-valid');
                }
                validateSum($(`#disaggregation_sum_${prefix}`), prefix);
            }
            return (ev) => {
                let $valueCell = $(ev.target);
                if ($valueCell.val() && (!$.isNumeric($valueCell.val()) || parseFloat($valueCell.val()) < 0)) {
                    $valueCell.addClass('is-invalid').removeClass('is-valid');
                    $(`#disaggregation_sum_${prefix}`).val('').removeClass('is-valid, is-invalid');
                } else if ($valueCell.val() == '') {
                    $valueCell.removeClass('is-invalid, is-valid');
                    updateSum();
                } else {
                    let value = Math.round(parseFloat($valueCell.val()) * 100) / 100;
                    $valueCell.val(value);
                    $valueCell.removeClass('is-invalid').addClass('is-valid');
                    updateSum();
                }
            }
        };
        $('td.value-cell').each(function() {
            // all disaggregated value cells should validate on change, and update their respective sum field
            $( this ).children('input').on('change', getDVHandler($( this ).data('prefix')));
       });
    });

    function cleanValueFields(prefix) {
        let valid = true;
        let values = [];
        
        // iterate over each value field in the form and check for numeric or null
        Array.from(
            Array(parseInt($(`#id_${prefix}-TOTAL_FORMS`).val())).keys()
        ).forEach(
            idx => {
                let valueField = $(`#id_${prefix}-${idx}-value`);
                valueField.removeClass('is-invalid');
                if (!valueField.val() || valueField.val() == '') {
                    //do nothing, null is okay
                } else if (!$.isNumeric(valueField.val()) || parseFloat(valueField.val()) < 0) {
                    valid = false;
                    valueField.addClass('is-invalid');
                    valueField.parent().addClass('has-error');
                } else {
                    // get decimal value:
                    valueField.val(Math.round(parseFloat(valueField.val()) * 100) / 100);
                    valueField.addClass('is-valid');
                    values.push({
                        value: valueField.val(),
                        labelPk: $(`#id_${prefix}-${idx}-label_pk`).val()
                    });
                }
            }
        );
        return valid && values;
    }
    
    function validateDisaggregations() {
        let valid = true;
        $('.disaggregation-table').find('.is-invalid').each(function() {
            valid = false;
        });
        return valid;
    }
</script>